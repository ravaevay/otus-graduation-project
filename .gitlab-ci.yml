variables:
  DOCKER_HOST: "tcp://docker:2375"
  DOCKER_TLS_CERTDIR: ""

stages:
  - testing

# -------------
# Testing
# -------------
test_ui:
  stage: testing
  image: docker/compose:1.29.2
  services:
    - docker:20.10.17-dind
  variables:
    COMPOSE_FILE: "microservices/src/docker-compose.yml:microservices/src/search_engine_ui/tests/docker-compose-tests.yml"
  script:
    - docker-compose up -d ui
    - docker exec -w / src_ui_1 pip install -r /ui/requirements-test.txt
    - docker exec -w / src_ui_1 coverage run -m unittest discover -s tests/
    - docker exec -w / src_ui_1 coverage report --include ui/ui.py
    - docker-compose down

test_crawler:
  stage: testing
  image: docker/compose:1.29.2
  services:
    - docker:20.10.17-dind
  variables:
    COMPOSE_FILE: "microservices/src/docker-compose.yml:microservices/src/search_engine_crawler/tests/docker-compose-tests.yml"
  script:
    - docker-compose up -d crawler
    - docker exec -w / src_crawler_1 ls -l / /crawler
    - docker exec -w / src_crawler_1 pip install -r /crawler/requirements-test.txt
    - docker exec -w / src_crawler_1 coverage run -m unittest discover -s tests/
    - docker exec -w / src_crawler_1 coverage report --include crawler/crawler.py
    - docker-compose down